import MagOrientation from '/img/MagOrientationDiagram.png'

# Magnetometer / Compass

:::warning

Do **NOT** enable a magnetometer unless you have confirmed that:

- the calibration is accurate
- its output is correctly oriented
- the returned values are clean and noise-free
- the heading returned by the mag is correct
- Acc is enabled, correctly oriented, and calibrated
- GPS is included in the firmware and enabled, to see the heading data
  :::

## Introduction

The purpose of a magnetometer is to return the 'heading' of the quad, meaning the direction the nose of the quad is pointing in. More precisely, we want the angle in degrees between the nose of the quad and North. When set up correctly, the returned value should, for example, be 90 degrees when the nose of the quad is pointing due East, 180 degrees when pointing due south, etc.

Mag information is essential for position hold, which we intend to support.

GPS Rescue does not require Mag data, but heading control may be improved if reliable, accurate Mag information is available, especially during descents on windy days. Note: DO NOT enable Mag if you rely on GPS rescue, unless you are ABSOLUTELY CERTAIN that the Mag data is accurate and reliable, and have confirmed that enabling Mag makes a significant improvement in rescue behaviour!

## What is a Magenetometer? {#magnetometer-explanation}

A magnetometer is a three-axis device that detects the local strength and direction of the [earth's magnetic field](https://en.wikipedia.org/wiki/Earth%27s_magnetic_field)[^1].

Magnetometer sensors output data on three mutually perpendicular axes: X, Y and Z. The relative relationship between the three axes can be arbitrary, depending on the magnetometer model (see documentation). But typically, the axes are arranged as follows: if Z is up, and X is forward, Y points left.

If the magnetometer has arrows indicating the direction of the X and Y axes on the board, the direction of the Z axis most likely will be:

- upwards, if the Y axis is 90° to the left of X axis, or
- downwards, if the Y axis is 90° to the right of the X axis

When one of the Mag sensor's three axes points directly parallel to a magnetic field line, that axis returns its most positive value, and the other two axes return zero. Conversely, when pointing into the opposite direction, the axis returns its most negative value, and the other two axes return zero. This is how the user can determine the orietnation of the axes in their module.

:::caution
The orientation of the magnetometer on the quad is very important. In Betaflight, the data from the magnetometer must be returned as follows:

- X must point **forward**
- Y must point **left**
- Z must point **up**
  :::

<figure className="align-center">
  <img src={MagOrientation} alt="Figure of magnetometer axes and orientation" className="no-effect " />
  <figcaption>
    <b>Fig. 1</b> - Magnetometer axes and orientation in relation to the drone as expected by Betaflight
  </figcaption>
  <br />
</figure>

In most standalone modules, such as the GY-271, the sensor is soldered on the top of the board, and typically the Z axis points upwards. In most GPS modules, the sensor is mounted upside-down, and the Z axis points downwards. The sensor can be soldered with it's X axis faces forward, or 180 degrees backwards, or left, or right. Hence the orientation of the axes varies greatly from module to module, and also varies depending on the orientation of the module when it is attached to the quadcopter.

If the magnetometer cannot be physically positioned so that its axes are aligned as per the diagram above, the `Mag alignment` setting in Configurator (`align_mag` in the [CLI](../configurator/cli-tab)) may be used to correct for other mag orientations. Standard corrections (e.g. `CW90` to rotate the axes 90 degrees clockwise) are provided for common alignment problems. If the module is tilted backwards, or at an unusual angle, a `custom` orientation correction will be required.

Correct orientation for a given axis can be confirmed by checking the Magnetometer data in the Sensors tab.

## About the Earth's Magnetic Vector Field

[The earth's magnetic field](https://en.wikipedia.org/wiki/Earth%27s_magnetic_field)[^1] is not uniform. Its field lines usually point a few degrees away from geographic North and point either slightly down or up in most places around the world. In other words: both the field direction and field strength vary from place to place.

If you check the earth's magnetic field at your location, it usually gets represented in a **NED** (north-east-down) frame of reference. This means that the X axis points North, the Y axis points East, and the Z axis points Down. This is not at all relevant for Betaflight's mag orientation on the quad, but it's useful to know for interpreting the magnetic field strength and direction at your location.

When we measure the magnetic field at a particular point on earth, we are measuring a local field vector which usually points a few degrees away from geographic North, and either down into the ground in the Northern Hemisphere, or up out of the ground in the Southern Hemisphere. There are considerable angular deviations, depending upon where you are on the surface of the Earth.

The sideways deviation of the Earth's magnetic field from the geographic north is called the **magnetic declination**. It is measured in degrees, with positive values meaning that the magnetic North is to the East of the geographic North.

The angle at which the field points into (or out of) the Earth's surface is called the **magnetic inclination**, or **magnetic dip**. See [physicsmax.com](https://physicsmax.com/inclination-dip-7371)[^2] for a nice explanation and graphic. Inclination is measured in degrees 'into' the ground. In the Northern Hemisphere the Earth's magnetic field points down into the ground (positive inclination values), and in the Southern Hemisphere it points up into the sky (negative inclination values).

Local declination and inclination values are available from online sources such as [NOAA](https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml)[^3], or via clickable map at sites like [magnetic-declination.com](https://www.magnetic-declination.com)[^4].

As an example, in Sydney, Australia, 34 degrees South and 151 degrees East, the Earth's magnetic field is 13 degrees east of the geographic North, and points out of the ground, steeply upwards, at 65 degrees. With a properly calibrated and correctly oriented Mag, a maximallly positive value on the Mag X axis should be seen in the Sensors tab, and close to zero on the Y and Z axes, when the nose of my quad is pointed 13 degrees East of North, and 65 degrees up.

The absolute strength of the field is measured in Gauss, or milliTeslas, where 10 Gauss = 1 milliTesla. In my location, the field strength is approximately 0.57 Gauss. Betaflight's sensors tab shows different numbers, perhaps due to internal scaling factors. Absolute field strength is not important for heading calculations.

## Hardware and Connection

Flight / FC firmware must be specially built to include `Magnetometers` for the cloud build, or `-DUSE_MAG` for local builds, otherwise there will be no Mag support in the firmware on the FC. Additionally, GPS firmware should be included in the build, because we display the Mag heading on Configurator's GPS tab, and use GPS debugs to display the Mag heading information.

Betaflight supports the following magnetometers:

- [AK8963](https://www.alldatasheet.com/datasheet-pdf/pdf/535561/AKM/AK8963.html)[^5] and [AK8975](https://www.alldatasheet.com/datasheet-pdf/pdf/535562/AKM/AK8975.html)[^6], (both discontinued; some versions have Z up, others down)
- [HMC5883L](https://cdn-shop.adafruit.com/datasheets/HMC5883L_3-Axis_Digital_Compass_IC.pdf)[^7] and [QMC5883L](https://datasheet.lcsc.com/szlcsc/QST-QMC5883L-TR_C192585.pdf)[^8]. These are provided on the common, and cheap, GY-217 module, and many GPS units.
- [IST8310](https://intofpv.com/attachment.php?aid=8104)[^9]
- [STM's LIS3MDL](https://www.st.com/resource/en/datasheet/lis3mdl.pdf)[^10]

`set mag_hardware = AUTO` in CLI is the default, and will automatically identify a connected and supported Mag.

The magnetometer is usually connected via i2C. Wire up the SCL and SDA pins on the module to the pins of the same name on the FC, and power the module with either 5V or 3.3V depending what it needs.

When connected by i2C, the following CLI settings are needed:

- `set mag_bustype = I2C`
- `set mag_i2c_address = 0` (automatically determine from the connected Mag)
- `set mag_i2c_device = 1` (always 1, not sure why)

When a Magnetometer is hooked up and is successfully connected:

- Mag can be enabled in the System Configuration part of the Configuration tab in Configurator, and then:
- the Mag hardware icon at the top (N with triangle above it) will illuminate
- Mag Alignment settings are available in the top right of the Configuration tab in Configurator
- in the Sensors tab, enabling Magnetometer at the top will display the current X, Y and Z magnetometer values
- the `status` command in CLI will show the detected Mag hardware

:::tip
The Accelerometer must always be enabled when using a Mag, to correct the heading estimate for pitch or roll variations!
:::

## Magnetometer Mounting and Orientation

As noted previously, Betaflight expects to receive magnetic field information on the basis that the X axis of the Mag points forward, the Y axis of the mag points left, and the Z axis points up. If this is not correctly configured, the Mag data will be useless, and could cause a GPS rescue to fail.

If you have an external Mag module that can be mounted in any angle you like, eg a GY-271, mount it:

- centrally
- flat to the quad, ie in the same plane of the FC
- as far as possible away from motors and other metallic onjects
- with the X axis pointing forward, directly to the nose of the quad, with Y left and Z up

If the Mag is provided with a GPS module, the above requirements also apply. Additionally, make sure the GPS is flat to the quad, otherwise you'll be messing with custom alignment settings. Also note that the Mag sensor may be inverted, or in an unknown orientation, as explained [above](#magnetometer-explanation). It will be absolutely essential to confirm the alignment properly before using the Mag!

:::tip
When the Mag orientation (alignment) is correct, the 'quad' icon in the Home screen of Configurator should move fairly smoothly and appropriately as the quad is rotated, pitched and rolled. Note that when the quad's attitude is changed very quickly, the heading will initially react quickly on the basis of Gyro and Acc data, and then over the next half second it will be adjusted by the Mag. If the orientation of the Mag data axes is wrong, or the calibration is way off, then these movements will be jerky or completely wrong.
:::

A simple orientation check is described in the 'tip' above.

If the orientation is known to be correct, ie X forward etc, because you can see the orientation markings on the board or have confirmed them by checking the little dot on the sensor, then the default or `CW0` alignment should be correct.

If you're unsure, or if you know it is rotated, or upside down, the `Mag alignment` setting in Configurator (`align_mag` in CLI) will need to be configured properly:

- if the mag is upright but rotated 90 degrees right, choose `CW90`, etc
- if the mag is inverted, choose one of the 'flip' options.

Note that 'flip' functionally rotates the Mag 180 degrees around the Y axis. You pretty much have to experiment with each possible orientation and hope, after checking, that you can find one that works. For the HMC5883L/QMC5883L, [this post](https://intofpv.com/t-betaflight-internals-coordinate-system?pid=55575#pid55575)[^11] shows a 'cheat sheet' that may help, but only if the chip itself is visible.

### Checking Magnetometer Orientation using Configurator's Sensors Tab

The Sensors Tab shows the current X, Y and Z Mag field strength values as detected by the sensor.

:::note
Before checking orientation, the sensor must first be calibrated!  
The calibration does not have to be perfect, but it must be done at least once.
:::

When a particular axis is perfectly aligned with the local magnetic field, the other two axes will show zero, or very close to zero. If the value shown is positive, that axis is pointing towards the North of the magnetic field. If negative, it's pointing South.

We can use this fact to check the orientation of the Mag after it is attached to the quadcopter. It's best to do this well away from large ferrous metal objects, eg out in an open field or something like that.

We need to know the 'north' direction of the Earth's magnetic field, approximately, at our location, so that we can point the nose of the quad kind of directly parallel to that magnetic field line when we go looking at the data returned by our Mag.

First, get your phone out, open it's Compass app, and mark a line on the bench or ground or whatever that points due North/South. Then draw a second line that takes into account the magnetic Declination for your location. In my case, some 13 degrees east of the geographic North. That declination-adjusted line points in the direction of Magnetic North.

Second, look up your local Inclination value. If you're in the Northern Hemisphere, you'll be pointing the nose of the quad downwards at that angle into the ground, along the North/South magnetic line, when testing the X axis of your sensor. If you're in the Southern Hemisphere, you'll be pointing at that angle up into the sky.

Then hook the quad up to Configurator, check the Sensors tab, point the nose of the quad as best possible directly into the magnetic field.

If everything is perfect, you should see a large, positive value in the X axis, and smaller, close to zero values in the Y and Z axes. With a bit of adjustment of the angle of the quad, you should be able to get the Y and Z axes really close to zero. If you figure that the nose of the quad looks like it's pointing North, and at the correct angle to the Horizon, and if X is by far the biggest number, then the X axis is aligned correctly!

You can then turn the quad 90 degrees right, pointing the 'left side' of the quad, where the Y axis of the sensor should be, directly to Magnetic North. If all is good, the Y axis data will be a big number and X and Z close to zero.

Finally, hold the quad so that the top of it is pointing directly into the magnetic field vector. By now you should have a good idea where that is. Z should then have a strongly positive value while X and Y should be close to zero.

Complex as this process seems, it is the only way to be 100% sure that the Mag is oriented correctly.

If you do not get the expected outcome, a software correction for the orientation of the Magnetometer will be required.

### Software Corrections for Magnetometer Orientation

To get these corrections right, you must know the direction of the magnetic field lines in your test environment. The mag must have been calibrated at some point before fixing the orientation.

The goal is to achieve the following result in the Sensors tab, when the specified part of the quad is pointed directly parallel to the field lines:

---

| Frame part parallel to field lines | X axis  | Y axis  | Z axis  |
| ---------------------------------- | ------- | ------- | ------- |
| Nose                               | Maximum | 0       | 0       |
| Left side                          | 0       | Maximum | 0       |
| Top                                | 0       | 0       | Maximum |

---

Usually it's best to do initial tests with the mag mounted flat and square to the frame, in the final position you'd like it to be. If the mag is in a GPS, and you plan to pitch the GPS back a bit, worry about the tilt later; keep it flat for now.

A good plan is to first check the Z axis. Confirm that it returns a strongly positive number when the top of the quad points directly parallel to the field lines. If you get a strongly negative value, the sensor is mounted upside down in the module. You should apply the `CW0_DEG_FLIP` correction at this point, and then move on to check X and Y.

To check X, move the quad around until you get a positive value on X, and then make smaller adjustments until you see a maximum on X and a zero on Y and Z. Let's say this happens when the right side of the quad is pointing directly parallel to the field lines. That means the X axis is pointing to the right of the quad, i.e. that the sensor is rotated 90 degrees clockwise. The appropriate correction, assuming Z was OK, would be `CW90`. If the Z axis was down, you'd need `CW90_FLIP`.

Each time you try a different software orientation, re-test by pointing the nose parallel to the field lines, looking for a max on X, then check that Y is max when the left side points parallel to the field lines, and finally that Z is max when the top of the quad points parallel to the field lines. There is an element of 'trial and error' involved.

If the Mag is a separate module, it is definitely easiest if it is mounted flat on the quad, with X forward and Z up, if at all possible.

If the Mag is in a GPS, and you want to pitch the GPS backwards at say 30 degrees an additional 30 degree correction will be required, that will also pitch the Mag backwards at 30 degrees.

Unfortunately, this means that the simple, standard `CW0` type corrections cannot be used. You will need to enable custom mag alignment, with `set align_mag = custom` in CLI. Then a value must be entered for each axis that requires correction, using, for example, `set mag_align_pitch = 300`, which compensates for a 30 degree pitch alignment problem.

It's probably best to:

- first determine the standard correction that works when the module is flat to the frame
- convert that to a set of custom corrections, in degrees, for each axis
- figure out what final change is required to correct for the picth offset of the module.

Here are some examples:

If the module requires no correction, i.e. it works perfectly, with X forward and Z up as expected in the CW0 or default orientation while flat, then it is pitched backwards 30 degrees, `set mag_align_pitch = 300` fixes it.

If the module requires a `CW90` correction while flat, then the combination of `set mag_align_yaw = 900` with `set mag_align_roll = -300` will fix the module being pitched backwards 90 degrees. The correction is required on roll since the sensor is logically rotated 90 degrees.

A module which requires a `CW90FLIP` correction, and is then pitched back 30 degrees, would require `set mag_align_pitch = 1800`, `set mag_align_yaw = 900` and
`set mag_align_roll = 300`.

Note that if the board is rotated 90 degrees, corrections for pitch must be done using roll.

## Magnetometer Calibration

Magnetometers must always be calibrated after being placed on the quad, before use, and before checking/confirming the orientation. A quick calibration is all that's needed before confirming the orientation, but a very accurate calibration may be useful if the accuracy of your heading estimate is important.

Calibration is needed because there can be very significant offsets in the magnetic field strength as detected by the sensor, mostly due to nearby metallic elements in the frame of the quad or on the circuit boards themselves.

The outcome of a calibration run is a set of values adjust 'centre' of the range of values detected for each axis. Once the correct calibration value is applied, all readings on that axis should be centered around zero. The maximum (most positive) and minimum (most negative) values for each axis should then be equal in value, but opposite in sign.

Cal values are saved in the `mag_calibration` CLI parameter. Once aquired, the cal values adjust the Mag values that are used to calculate the heading of the quad. For example, `set mag_calibration = 35,-130,-75` will cause the heading code to first subtract 35 from every X reading, add 130 to every Y reading, and add 75 ro every Z reading.

For the most accurate calibration results:

- calibrate the quad at, or close to, the intended flight location
- keep well away from metallic or magnetic objects
- get a long USB cable and don't have magnetic objects on your body or in your pockets
- do several runs, and confirm that the cal values are consistent each time
- (expert only) validate that absolute min and max readings are equal on each axis

Calibration values should not need to change much from flying area to area, within your local district. They may require updating or checking in areas of high magnetism or very variable local field strength.

:::note
Calibration itself **DOES NOT** check that the orientation of the sensor is correct!
:::

### Calibration Using the 'Calibrate Magnetometer` Button in Configurator.

This method is the quickest and easiest way to calibrate the sensor. It's best to do several runs and to check that the values you get are consistent.

The quad should be rotate in all possible vectors, so that each axis of the sensor gets pointed in all possible directions in relation to the earth's field. 30s is provided to acquire samples. The software can calculate cal values from from the array of values acquired during the test.

Do not rotate the frame too fast, or too slowly. Smoothly completing full rotations about every 1.5-2 seconds works best. Try to ensure that, for example, the nose of the quad points in all possible directions during the 30s period. This will ensure that the other axes also point in all possible directions.

Sometimes aiming to pitch flip the quad in a north-south plane in relation to the known magnetic field for half the time, nose over tail, then turning the quad 90 degrees and roll-flipping the quad left over right, can give reliable results, but you'll then need to be reasonably sure you have a good 'feel' for the orientation of the field in your area.

Check the `mag_calibration` CLI parameter after each run to see how consistent the values are. If each value is within 50 units of the last couple of runs, that's pretty good.

If accuracy is important, you can choose to average the values in the most consistent runs. It's also possible to explicitly focus on rotating on pitch alone in the magnetic field axis, trying to get consistent X and Z values, and choosing the most consistent numbers there; then rotating on roll alone, again aiming to traverse the magnetic field axis frequently, until you get consistent Y and Z values.

### Checking and Fine-Tuning in Sensors Tab.

Once you get consistent values from your calibration tests, the pilot can validate the accuracy of the cal factor by checking that the absolute minimum and maximum values are, for a given axis, equal. This must be done in the exact same location that the original calibration was performed at, ideally soon after, or at the same time.

This is done by carefully pointing, say, the nose of the quad carefully and directly into the magnetic field, while checking the X axis numbers in the sensors tab. When the Y and Z values are zero, or close to zero, the X value will be biggest. Note the biggest positive value that you see. Then rotate the quad 180 degrees, and note the most negative value that you see. If the cal factor is 'perfect' these values will be equal, but opposite. If the difference is small, it can be ignored. If you are a perfectionist, you can adjust the cal value for X in the CLI, manually, and try again. This process can be repeated for each of the three axes.

Using the sensors tab in this manner to check max and min for each axis will also identify whether the existing calibration is suitable for a new location, or not. If max and min are very close to equal, you don't need to recalibrate.

## What About My Heading Information and Signal Noise?

Heading information is provided to the quad by the GPS unit (course over ground), the IMU (gyro information while turning quickly), and the Mag unit. The IMU code uses 'sensor fusion' methods to integrate this data to a final 'attitude' or 'heading' value for the quad.

If the code is built with GPS support, and a GPS Uart is enabled, you can log the heading information from GPS and Mag, while flying, with the GPS Heading debug.

Heading is also shown on the main front screen of Configurator, at the top left of the quad icon area. If Mag is enabled, the heading shown reflects Mag data. Otherwise it starts at 359 degrees and changes when the frame is yawed.

:::tip
If everything is working properly, the quad's icon, as shown in the main page of Configurator, should move without sudden jumps, once Mag is enabled. Sudden jumps after quick movements usually mean that the orientation is not correct.
:::

The reported Mag heading can be seen in Debug 4 of the GPS Heading Debug in the Sensors tab, but only if GPS support exists in the build. We will most likely show Mag heading in other debugs, just haven't done that yet.

Incoming mag X, Y and Z values are always logged to Blackbox, and should be examined to ensure they are not really noisy. The noise should be much less than the signal. If noise is obviously an issue, mount the mag further away from the motors, ensuring that the sensor is equidistant from pairs of motors, and check that there is adequate filtering on the power supply to the Mag module.

_Drafted by **ctzsnooze** in 2023-09 for Betaflight 4.6. Huge shout out to **ledvinap** and **pichim** for their help and guidance._

## External Links

[^1]: [Earth's Magnetic Field - Wikipedia](https://en.wikipedia.org/wiki/Earth%27s_magnetic_field)
[^2]: [Inclination or Dip - PhysicsMax](https://physicsmax.com/inclination-dip-7371)
[^3]: [Magnetic Field Calculators - NOAA](https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml)
[^4]: [Inclination and Declination map](https://www.magnetic-declination.com)
[^5]: [AK8963 datasheet (disccontinued)](https://www.alldatasheet.com/datasheet-pdf/pdf/535561/AKM/AK8963.html)
[^6]: [AK8975 datasheet (discontinued)](https://www.alldatasheet.com/datasheet-pdf/pdf/535562/AKM/AK8975.html)
[^7]: [HMC5883L datasheet](https://cdn-shop.adafruit.com/datasheets/HMC5883L_3-Axis_Digital_Compass_IC.pdf)
[^8]: [QMC5883L datasheet](https://datasheet.lcsc.com/szlcsc/QST-QMC5883L-TR_C192585.pdf)
[^9]: [IST8310 datasheet](https://intofpv.com/attachment.php?aid=8104)
[^10]: [LIS3MDL datasheet](https://www.st.com/resource/en/datasheet/lis3mdl.pdf)
[^11]: [HMC5883L/QMC5883L cheat sheet](https://intofpv.com/t-betaflight-internals-coordinate-system?pid=55575#pid55575)
